---
description: 드론 한대를 제어하기 위해 개발된 클래스
---

# Vehicle Class

## Public Interface

| **함수 이름**(입력 인자)                                                                                                        |                                                                                 **관련 변수**(타입)                                                                                 | **실행시 구동되는 동작**                                                                                                                                                                               |
| ----------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><strong>Vehicle</strong></p><p>(ros::NodeHandle &#x26;, ros::NodeHandle &#x26;)</p>                                  |                                                                                  대부분의 클래스 변수                                                                                  | Vehicle 객체를 생성하기 위한 가장 기본적인 생성자. 변수 초기화가 목적.                                                                                                                                                  |
| <p><strong>Vehicle</strong></p><p>(ros::NodeHandle &#x26;, ros::NodeHandle &#x26;, </p><p>const VehicleInfo &#x26;)</p> |                                                                                  대부분의 클래스 변수                                                                                  | VehicleInfo를 받아서 그 정보에 맞는 Vehicle 객체를 생성하는 생성자.                                                                                                                                               |
| <p><strong>Vehicle</strong></p><p>(const Vehicle &#x26;)</p>                                                            |                                                                                  대부분의 클래스 변수                                                                                  | <p>복사 생성자. 다른 Vehicle 객체로 부터 변수값을 카피해서 새로운 Vehicle 객체를 생성함.</p><p><strong>복사 생성자를 구현하지 않을 경우 std::vector 같은 template library를 사용할 수 없다.</strong></p>                                          |
| <p>const Vehicle </p><p><strong>&#x26;operator=</strong></p><p>(const Vehicle &#x26;)</p>                               |                                                                                  대부분의 클래스 변수                                                                                  | 대입 연산자 오버로딩. 복사 생성자와 마찬가지의 역할을 수행하며 구현하지 않을 경우의 제약 또한 같다.                                                                                                                                     |
| **\~Vehicle**()                                                                                                         |                                                                               ROS 관련 토픽, 서비스 변수                                                                               | ROS와 관련된 publisher, subscriber, serviceClient 객체를 종료 시킨다.                                                                                                                                     |
| <p>void <strong>setVehicleInfo</strong></p><p>(const VehicleInfo &#x26;)</p>                                            |                                                                    <p>vehicle_info_</p><p>(VehicleInfo)</p>                                                                   | 입력 파라미터의 차량 정보에 따라 현재 Vehicle 객체의 정보 및 NodeHandle의 정보를 업데이트 한다.                                                                                                                               |
| <p>VehicleInfo <strong>getInfo</strong>() </p><p>const</p>                                                              |                                                                    <p>vehicle_info_</p><p>(VehicleInfo)</p>                                                                   | vehicle\_info\_ 구조체를 리턴한다.                                                                                                                                                                    |
| <p>mavros_msgs::State </p><p><strong>getState</strong>() const</p>                                                      |                                             <p>state_sub_</p><p>(ros::Subscriber),</p><p>cur_state_</p><p>(mavros_msgs::State)</p>                                            | Subscribe한 드론의 상태(mavros와의 연결 여부, arm 여부, guided 모드 여부, manual input 여부, 현재 모드, 시스템 상태)를 리턴한다.                                                                                                |
| <p>sensor_msgs</p><p>::BatteryState <strong>getBattery</strong>() const</p>                                             |                                       <p>battery_sub_</p><p>(ros::Subscriber),</p><p>cur_battery_</p><p>(sensor_msgs::BatteryState)</p>                                       | Subscribe한 배터리 정보(전압, 전류, 잔량, 헤더)를 리턴한다.                                                                                                                                                      |
| <p>bool <strong>arming</strong></p><p>(const bool &#x26;)</p>                                                           |                                           <p>arming<em>client</em> </p><p>(ros::ServiceClient)</p><p>arming_yaw_ </p><p>(double)</p>                                          | <p>입력 파라미터의 값이 True이면 드론을 시동이 걸린상태(Armed)로 바꾸로 False가 입력되면 시동이 꺼진상태(Disarmed) 상태로 변경하도록 요청한다. <strong>드론의 상황에 따라 요청이 거절 될 수 있다.</strong></p><p>함수가 요청 될 때, 현재의 yaw 값을 arming_yaw_에 기록한다. </p> |
| <p>bool <strong>setMode</strong></p><p>(const std::string &#x26;)</p>                                                   |                                                                     set_mode\_client_ (ros::ServiceClient)                                                                    | 드론을 입력되는 문자열에 해당하는 모드로 변경하도록 요청한다. 입력가능한 모드는 MANUAL, STABILIZED, OFFBOARD, POSCTL, AUTO.TAKEOFF 등이 있다. 드론의 **상황에 따라서 모드 변경이 불가능 한 경우 요청이 거절 될 수 있다.**                                         |
| <p>bool <strong>takeoff</strong></p><p>(const double &#x26;)</p>                                                        |                                                               <p>takeoff_client_</p><p>(ros::ServiceClient)</p>                                                               | <p>드론을 특정 글로벌 위치(GPS 기반 longitude, latitude)에서 원하는 고도와 Yaw 값으로 takeoff 모드로 비행 시키는 기능.</p><p><strong>군집드론으로 할 시 GPS가 잡히기 전에 함수가 호출되면 시뮬레이션에서는 드론이 발산 할 수 있다.</strong></p>                      |
| bool **land**()                                                                                                         |                                                                 <p>land_client_</p><p>(ros::ServiceClient)</p>                                                                | <p>드론을 특정 글로벌 위치(GPS 기반 longitude, latitude)에 착륙시키는 기능.</p><p><strong>현재는 입력 파라미터가 없이 제자리에서 착륙하도록 구현되어 있다.</strong></p>                                                                       |
| <p>void <strong>gotoGlobal</strong></p><p>(const sensor_msgs</p><p>::NavSatFix &#x26;)</p>                              |                 <p>tar_global_</p><p>(sensor_msgs::NAvSatFix)</p><p>setpoint_global_pub_</p><p>(ros::Publisher),</p><p>setpoint_publish_flag_</p><p>(bool)</p>                | <p>드론을 특정 글로벌 위치(GPS 기반 longitude, latitude, altitude)로 이동 하도록 입력 파라미터로 들어온 좌표를 1번 Publish 해준다.</p><p><strong>함수 구현은 되어 있으나 현재 사용되고 있지 않다.</strong></p>                                       |
| <p>void <strong>setLocalTarget</strong></p><p>(const geometry_msgs</p><p>::PoseStamped &#x26;)</p>                      |                                     <p>tar_local_</p><p>(geometry_msgs</p><p>::PoseStamped),</p><p>setpoint_publish_flag_</p><p>(bool)</p>                                    | 드론의 타겟 로컬 포지션(x, y, z)을 입력 파라미터로 들어온 포지션으로 변경한다.                                                                                                                                              |
| void **gotoLocal**()                                                                                                    | <p>setpoint_pos_</p><p>(geometry_msgs</p><p>::PoseStamped),</p><p>setpoint_local_pub_</p><p>(ros::Publisher)</p><p>turned_yaw_, pitch_, roll_, arming_yaw_</p><p>(double)</p> | <p>객체에 저장된 특정 로컬 포지션 위치(setpoint_pos_)로 드론이 이동하도록 토픽을 1번 Publish 해준다.<br><strong>드론이 정상적으로 비행하기 위해선 이 데이터가 최소 2Hz 이상으로 전달 되어야 한다.</strong>  </p><p>드론의 내부 제어기를 사용하는 위치제어 방식이다.</p>            |
| <p>void <strong>setPos</strong></p><p>(const tf2::Vector3 &#x26;)</p>                                                   |                                                                        <p>pos_</p><p>(tf2::Vector3)</p>                                                                       | 군집드론을 제어하기위한 통합 좌표계를 만들기 위해 1번 드론의 홈좌와 현재 드론의 GPS 위치 차이를 통해 1번 드론의 홈자표를 기준으로 생성된 통합 좌표계 내에서의 드론 위치(x, y, z)를 저장하기 위한 함수이다.                                                                    |
| <p>tf2::Vector3 <strong>getPos</strong>() </p><p>const</p>                                                              |                                                                        <p>pos_</p><p>(tf2::Vector3)</p>                                                                       | 1번 드론의 홈좌표를 기준으로 생성된 통합좌표계 내에서의 드론 위치(x, y, z)를 리턴한다.                                                                                                                                         |
| <p>void <strong>setSumOfSp</strong></p><p>(const tf2::Vector3 &#x26;)</p>                                               |                                                                      <p>sum_sp_</p><p>(tf2::Vector3)</p>                                                                      | 통합 좌표계 상의 드론 위치들을 기반하여 현재 Vehicle 객체 주변의 특정 범위 안의 드론들과 멀어지는 방향으로의 힘(x, y, z)을 저장하는 함수이다.                                                                                                      |
| <p>tf2::Vector3 </p><p><strong>getSumOfSp</strong>() const</p>                                                          |                                                                      <p>sum_sp_</p><p>(tf2::Vector3)</p>                                                                      | 주변의 특정 범위 안의 드론들과 멀어지는 방향으로의 힘(x, y, z)을 리턴한다.                                                                                                                                                |
| <p>void <strong>setErr</strong></p><p>(const tf2::Vector3 &#x26;)</p>                                                   |                                                                        <p>err_</p><p>(tf2::Vector3)</p>                                                                       | 드론의 타겟지점과 현재 로컬 포지션과의 차이를 힘(x, y, z)으로써 저장하는 함수이다.                                                                                                                                            |
| tf2::Vector3 **getErr**() const                                                                                         |                                                                        <p>err_</p><p>(tf2::Vector3)</p>                                                                       | 드론의 타겟지점과 현재 로컬 포지션과의 차(x, y, z)를 리턴한다.                                                                                                                                                       |
| <p>void <strong>setSetpointPos</strong></p><p>(const tf2::Vector3 &#x26;)</p>                                           |                                                                   <p>setpoint_pos_</p><p>(tf2::Vector3)</p>                                                                   | 드론의 현재 좌표에 타겟 지점에 다가가려는 seek()와 주변 드론과 멀어지려는 sumOfSp()를 합성하여 생긴 벡터를 더해 근거리 경로를 생성하여 저장한다.                                                                                                     |
| <p>tf2::Vector3 </p><p><strong>getSetpointPos</strong>() const</p>                                                      |                                                                   <p>setpoint_pos_</p><p>(tf2::Vector3)</p>                                                                   | 드론의 근거리 경로 지점을 리턴한다.                                                                                                                                                                          |
| bool **setHomeGlobal**()                                                                                                |                                      <p>set_home_client_</p><p>(ros::ServiceClient)</p><p>home_global_</p><p>(sensor_msgs::NavSatFix)</p>                                     | 현재의 GPS좌표를 받아와서 드론의 홈좌표로 지정되도록 요청한다.                                                                                                                                                          |
| sensor\_msgs::NavSatFix **getHomeGlobal**() const                                                                       |                                                               <p>home_global_</p><p>(sensor_msgs::NavSatFix)</p>                                                              | 현재 객체에 저장되어 있는 드론의 홈좌표를 리턴한다.                                                                                                                                                                 |
| sensor\_msgs::NavSatFix **getGlobalPosition**() const                                                                   |                                                               <p>cur_global_</p><p>(sensor_msgs::NavSatFix)</p>                                                               | 지속적으로 Subscribe 하여 업데이트 되고 있는 현재의 GPS 좌표를 리턴한다.                                                                                                                                               |
| sensor\_msgs::NavSatFix **getTargetGlobal**() const                                                                     |                                                               <p>tar_global_</p><p>(sensor_msgs::NavSatFix)</p>                                                               | void gotoGlobal(const sensor\_msgs::NavSatFix &) 함수를 통해 설정된 GPS 기반 타겟지점을 리턴한다.                                                                                                                |
| void **setHomeLocal**()                                                                                                 |                                                          <p>home_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p>                                                         | 현재의 로컬 좌표를 로컬 홈으로 설정한다. **사실 실제 드론 펌웨어에 local\_home에 대한 개념이 없기 때문에 구현은 해 놓았으나 현재 특별히 사용되고 있지 않다.**                                                                                            |
| <p>geometry_msgs</p><p>::PoseStamped <strong>getHomeLocal</strong>() const</p>                                          |                                                          <p>home_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p>                                                         | 현재 설정된 로컬 홈 좌표를 리턴한다.                                                                                                                                                                         |
| <p>geometry_msgs</p><p>::PoseStamped <strong>getLocalPosition</strong>() const</p>                                      |                                                          <p>cur_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p>                                                          | 지속적으로 Subscribe 하여 업데이트 되고 있는 현재의 로컬 포지션 좌표를 리턴한다.                                                                                                                                            |
| <p>geometry_msgs</p><p>::PoseStamped <strong>getTargetLocal</strong>() const</p>                                        |                                                          <p>tar_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p>                                                          | void setLocalTarget(const geometry\_msgs::PoseStamped &) 함수를 통해 설정된 로컬 타겟지점을 리턴한다.                                                                                                            |
| double **getArmingYaw**()                                                                                               |                                                                       <p>arming_yaw_</p><p>(double)</p>                                                                       | <p>Arm 요청이 갔을 때 기록된 yaw 값을 리턴한다. </p><p>IMU로 부터 측정된 쿼터니언 값으로 부터 yaw 값을 측정하는데 compass의 흔들림으로 경험적으로 +-5 drgee 정도의 오차가 존재한다.</p>                                                                 |
| bool **isPublish**() const                                                                                              |                                                                   <p>setpoint_publish_flag_</p><p>(bool)</p>                                                                  | gotoGlobal 또는 setLocalTarget에 의해 어떠한 목표지점이 설정 되었는지 여부를 리턴한다.                                                                                                                                  |

## Private Interface

| 함수 이름                                                                                                                | 관련 변수(타입)                                                                                                   | 실행시 구동되는 동작                                                                                                                                                                        |
| -------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| void **vehicleInit**()                                                                                               | ROS와 관련된  토픽, 서비스 관련 변수                                                                                     | 드론의 기본적인 정보를 받아오기 위해 토픽과 서비스 정보 초기화.                                                                                                                                               |
| void **release**()                                                                                                   | ROS와 관련된  토픽, 서비스 관련 변수                                                                                     | ROS와 관련된 publisher,   subscriber, serviceClient 객체를 종료.                                                                                                                            |
| <p>void <strong>stateCB</strong></p><p>(const mavros_msgs</p><p>::State::ConstPtr &#x26;)</p>                        | <p>cur_state_</p><p>(mavros_msgs::State)</p>                                                                | 드론으로부터 Publish 되는 state정보를 cur\_state\_ 변수에 기록하고 변화가 있는 내용을 ROS\_INFO로 출력한다.                                                                                                       |
| <p>void <strong>batteryCB</strong></p><p>(const sensor_msgs</p><p>::BatteryState::ConstPtr &#x26;)</p>               | <p>cur_battery_</p><p>(sensor_msgs</p><p>::BatteryState)</p>                                                | 드론으로부터 Publish 되는 배터리 정보를 cur\_battery\_ 변수에 기록한다.                                                                                                                                 |
| <p>void <strong>homeCB</strong></p><p>(const mavros_msgs</p><p>::HomePosition::ConstPtr &#x26;)</p>                  | <p>home_global_<br>(sensor_msgs::NavSatFix)</p><p>home_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p> | <p>드론으로부터 Publish 되는 홈좌표를 home_global_과 home_local_에 기록한다.</p><p><strong>mavros_msgs::HomePosition에서는 글로벌과 로컬에 대한 홈좌표가 publish 되지만 우리가 임의로 설정 할 수 있는 홈좌표는 글로벌 좌표 뿐이다.</strong></p> |
| <p>void <strong>globalPositionCB</strong></p><p>(const sensor_msgs</p><p>::NavSatFix::ConstPtr &#x26;)</p>           | <p>cur_global_</p><p>(sensor_msgs::NavSatFix)</p>                                                           | 드론으로부터 Publish 되는 현재 드론의 GPS 위치를 cur\_global\_에 기록한다.                                                                                                                              |
| <p>void <strong>localPositionCB</strong></p><p>(const geometry_msgs</p><p>::PoseStamped</p><p>::ConstPtr &#x26;)</p> | <p>cur_local_</p><p>(geometry_msgs</p><p>::PoseStamped)</p>                                                 | 드론으로부터 Publish 되는 현재 드론의 로컬 포지션을 cur\_local\_에 기록한다.                                                                                                                               |
| <p>void <strong>turnCB</strong></p><p>(const std_msgs::Bool</p><p>::ConstPtr &#x26;)</p>                             | turned\_yaw\_                                                                                               | 0으로 초기화 되어 있는 turned\_yaw\_ 변수를 π/2 만큼씩 변화 시켜 주기적으로 실행되는 위치제어 함수인 gotoLocal()에서 yaw가 시계방향으로 90도씩 돌아가도록 한다.                                                                         |
| <p>void <strong>multiArming</strong></p><p>(const std_msgs::Bool</p><p>::ConstPtr &#x26;)</p>                        | -                                                                                                           | <p><strong>군집 드론의 전체적인 arming 신호를 보내기 위해 토픽을 1:N으로 설계하여 내장한 별도의 arming 함수.</strong><br>내부적으로는 arming() 함수에 입력 파라미터를 전달 하는 방식으로 구현된다.</p>                                           |
| <p>void <strong>multiSetMode</strong></p><p>(const std_msgs::String<br>::ConstPtr &#x26;)</p>                        | -                                                                                                           | <p><strong>군집 드론의 전체적인 setMode 명령을 요청하기 위해 토픽을 1:N으로 설계하여 내장한 별도의 setMode 함수.</strong><br>내부적으로는 setMode() 함수에 입력 파라미터를 전달 하는 방식으로 구현된다.</p>                                       |
| <p>void <strong>multiSetHome</strong></p><p>(const std_msgs::Empty</p><p>::ConstPtr &#x26;)</p>                      | -                                                                                                           | <p><strong>군집 드론의 전체적인 setHome 명령을 요청하기 위해 토픽을 1:N으로 설계하여 내장한 별도의 setHome 함수.</strong><br>내부적으로는 setHomeGlobal()과 setHomeLocal() 함수를 실행하는 방식으로 구현된다.</p>                           |
| <p>void <strong>multiTakeoff</strong></p><p>(const std_msgs::Empty</p><p>::ConstPtr &#x26;)</p>                      | -                                                                                                           | <p><strong>군집 드론의 전체적인 takeoff 명령을 요청하기 위해 토픽을 1:N으로 설계하여 내장한 별도의 takeoff 함수.</strong><br>내부적으로는 takeoff() 함수에 파라미터로 설정된 takeoff_alt_ 값을 전달 하는 방식으로 구현된다.</p>                      |
| <p>void <strong>multiLand</strong></p><p>(const std_msgs::Empty</p><p>::ConstPtr &#x26;)</p>                         | -                                                                                                           | <p><strong>군집 드론의 전체적인 land 명령을 요청하기 위해 토픽을 1:N으로 설계하여 내장한 별도의 land 함수.</strong><br>내부적으로는 land() 함수를 실행하는 방식으로 구현된다.</p>                                                          |

